#!/usr/bin/env bash

set -e

source ~/.local/src/trskop/command-wrapper/bash/lib.sh

function printHelp() {
    cat <<EOF
${COMMAND_WRAPPER_NAME} jmp [-h|--help]
EOF
}

function declareCfg() {
    local -r configFile="$1"; shift

    dhall-to-bash --declare 'menuCommand' <<EOF
let i = ${configFile}
in  [i.menu.command] # i.menu.arguments
EOF
    echo

    dhall-to-bash --declare 'editorCommand' <<EOF
let i = ${configFile}
in  [i.editor.command] # i.editor.arguments
EOF
    echo
}

function main() {
    dieIfExecutedOutsideOfCommandWrapperEnvironment

    local arg
    while (( $# )); do
        arg="$1"; shift
        case "${arg}" in
            -h|--help)
                printHelp
                exit 0
                ;;
            -*)
                die 1 "'%s': %s" "${arg}" 'Unknown option.'
                ;;
            *)
                die 1 "'%s': %s" "${arg}" 'Too many arguments.'
                ;;
        esac
    done

    if [[ -z "${TMUX}" || -z "${TMUX_PANE}" ]]; then
        die 1 "Not running in a Tmux pane."
        exit 1
    fi

    eval "$(declareCfg "${COMMAND_WRAPPER_CONFIG}")"

    tmux capture-pane -S - -b scroll-buffer \; show-buffer -b scroll-buffer \; delete-buffer -b scroll-buffer \
    | sed -rn 's/^ *(.*):([0-9]+):[0-9]+: error:$/\1 +\2/;T;p' \
    | uniq \
    | "${menuCommand[@]}" \
    | xargs -r "${editorCommand[@]}"
}

main "$@"
